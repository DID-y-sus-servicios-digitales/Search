<!DOCTYPE html>
<html>
<head>
    <title>Detección de caras</title>
    <style>
        #camara1, #camara2 {
            width: 320px;
            height: 240px;
            border: 1px solid black;
        }
        #fotos {
            display: flex;
            flex-wrap: wrap;
        }
        .foto-pequena {
            width: 100px;
            height: 100px;
            margin: 5px;
            border: 1px solid gray;
        }
    </style>
</head>
<body>
    <video id="camara1" autoplay></video>
    <video id="camara2" autoplay></video>
    <div id="fotos"></div>

    <script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
    <script>
        const camara1 = document.getElementById('camara1');
        const camara2 = document.getElementById('camara2');
        const fotos = document.getElementById('fotos');

        Promise.all([
            faceapi.nets.tinyFaceDetector.loadFromUri('/models')
        ]).then(iniciarCamaras);

        async function iniciarCamaras() {
            const dispositivos = await navigator.mediaDevices.enumerateDevices();
            const camaras = dispositivos.filter(dispositivo => dispositivo.kind === 'videoinput');

            if (camaras.length >= 2) {
                const stream1 = await navigator.mediaDevices.getUserMedia({ video: { deviceId: camaras[0].deviceId } });
                const stream2 = await navigator.mediaDevices.getUserMedia({ video: { deviceId: camaras[1].deviceId } });
                camara1.srcObject = stream1;
                camara2.srcObject = stream2;

                detectarCaras(camara1);
                detectarCaras(camara2);
            } else {
                alert('Se necesitan al menos dos cámaras.');
            }
        }

        async function detectarCaras(camara) {
            const canvas = faceapi.createCanvasFromMedia(camara);
            document.body.append(canvas);
            const displaySize = { width: camara.videoWidth, height: camara.videoHeight };
            faceapi.matchDimensions(canvas, displaySize);

            setInterval(async () => {
                const detecciones = await faceapi.detectAllFaces(camara, new faceapi.TinyFaceDetectorOptions());
                const deteccionesRedimensionadas = faceapi.resizeResults(detecciones, displaySize);
                canvas.getContext('2d').clearRect(0, 0, canvas.width, canvas.height);
                faceapi.draw.drawDetections(canvas, deteccionesRedimensionadas);

                if (deteccionesRedimensionadas.length > 0) {
                    tomarFoto(camara);
                }
            }, 100);
        }

        function tomarFoto(camara) {
            const canvas = document.createElement('canvas');
            canvas.width = camara.videoWidth;
            canvas.height = camara.videoHeight;
            const contexto = canvas.getContext('2d');
            contexto.drawImage(camara, 0, 0, canvas.width, canvas.height);

            const fotoURL = canvas.toDataURL('image/png');
            mostrarFoto(fotoURL);
        }

        function mostrarFoto(fotoURL) {
            const fotoPequena = document.createElement('img');
            fotoPequena.src = fotoURL;
            fotoPequena.classList.add('foto-pequena');

            fotoPequena.addEventListener('click', () => {
                descargarFoto(fotoURL);
            });

            fotos.appendChild(fotoPequena);
        }

        function descargarFoto(fotoURL) {
            const enlaceDescarga = document.createElement('a');
            enlaceDescarga.href = fotoURL;
            enlaceDescarga.download = 'cara.png';
            enlaceDescarga.click();
        }
    </script>
</body>
</html>
