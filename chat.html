<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Videollamada Sencilla</title>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: #f0f0f0;
        }

        .container {
            width: 80%;
            max-width: 800px;
            background-color: #fff;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
        }

        #video-container {
            display: flex;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        video {
            width: 100%;
            max-width: 400px;
            margin: 10px;
            border: 2px solid #666;
            border-radius: 5px;
            background-color: #000;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #007bff;
            color: #fff;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #0056b3;
        }

        #call-status {
            margin-top: 20px;
            font-size: 18px;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Videollamada Sencilla</h1>
        <div id="video-container">
            <video id="local-video" autoplay muted playsinline></video>
            <video id="remote-video" autoplay playsinline></video>
        </div>
        <button id="start-call">Iniciar Videollamada</button>
        <p id="call-status">Esperando para Iniciar</p>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/peerjs@1.3.2/dist/peer.min.js"></script>
    <script>
        const localVideo = document.getElementById('local-video');
        const remoteVideo = document.getElementById('remote-video');
        const startCallButton = document.getElementById('start-call');
        const callStatus = document.getElementById('call-status');

        let peer;
        let localStream;
        let remoteStream;
        let isCalling = false;

        // Configuración de STUN para la conexión Peer-to-Peer
        const peerConfig = {
            host: 'peerjs.herokuapp.com',  // Servidor PeerJS
            port: 443,
            secure: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' },
                    { urls: 'stun:stun1.l.google.com:19302' },
                    { urls: 'stun:stun2.l.google.com:19302' }
                ]
            }
        };

        // 1. Obtener acceso a la cámara y micrófono del usuario
        async function getMediaStream() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                localStream = stream;
                localVideo.srcObject = stream;
            } catch (error) {
                console.error('Error al obtener la transmisión de medios:', error);
                callStatus.textContent = 'No se pudo acceder a la cámara y al micrófono. Asegúrate de que están permitidos.';
            }
        }

        // 2. Inicializar la conexión Peer-to-Peer
        function startPeer() {
            try {
                peer = new Peer(null, peerConfig); // No se proporciona ID, se asignará uno.
                peer.on('open', (id) => {
                    console.log('ID de Peer:', id);
                    callStatus.textContent = `Listo para llamar o recibir llamada. Tu ID es: ${id}`;
                    startCallButton.textContent = 'Llamar a Otro Usuario'; // Cambiar texto del botón
                    startCallButton.disabled = false;
                });

                peer.on('call', (call) => {
                    // 4. Responder a una llamada entrante
                    call.answer(localStream);
                    setupCall(call);
                });

                peer.on('error', (err) => {
                    console.error('Error de Peer:', err);
                    callStatus.textContent = 'Error de conexión Peer: ' + err.message;
                });

            } catch (error) {
                console.error('Error al inicializar Peer:', error);
                callStatus.textContent = 'Error al iniciar la conexión Peer: ' + error.message;
            }
        }

        // 5. Configurar la llamada (para enviar o recibir)
        function setupCall(call) {
            call.on('stream', (stream) => {
                remoteStream = stream;
                remoteVideo.srcObject = stream;
            });

            call.on('close', () => {
                console.log('Conexión cerrada');
                callStatus.textContent = 'Llamada finalizada.';
                remoteVideo.srcObject = null;
                isCalling = false;
                startCallButton.textContent = 'Iniciar Videollamada';
                startCallButton.disabled = false;
                if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
            });

            call.on('error', (err) => {
                console.error('Error en la llamada:', err);
                callStatus.textContent = 'Error en la llamada: ' + err.message;
                remoteVideo.srcObject = null;
                isCalling = false;
                startCallButton.textContent = 'Iniciar Videollamada';
                startCallButton.disabled = false;
                 if (localStream) {
                    localStream.getTracks().forEach(track => track.stop());
                }
            });
        }

        // 3. Iniciar una llamada a otro usuario
        async function startCall() {
            if (!peer) {
                alert('Por favor, espera a que se inicialice la conexión Peer.');
                return;
            }

            const peerIdToCall = prompt('Introduce el ID del usuario al que quieres llamar:');
            if (!peerIdToCall) {
                alert('Debes introducir un ID de usuario para llamar.');
                return;
            }

            try {
                const call = peer.call(peerIdToCall, localStream);
                if (!call) {
                    alert('No se pudo establecer la llamada.  Asegúrate de que el ID es correcto y el otro usuario está en línea.');
                    return;
                }
                setupCall(call);
                callStatus.textContent = `Llamando a ${peerIdToCall}...`;
                startCallButton.disabled = true;
                isCalling = true;

            } catch (error) {
                console.error('Error al iniciar la llamada:', error);
                callStatus.textContent = 'Error al iniciar la llamada: ' + error.message;
            }
        }

        // Inicializar la aplicación
        getMediaStream().then(() => {
            startPeer();
            startCallButton.addEventListener('click', startCall);
        });
    </script>
</body>
</html>

